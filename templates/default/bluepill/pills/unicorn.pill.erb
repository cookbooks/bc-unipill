rails_env   = ENV['RAILS_ENV']  || "development"
rails_root  = ENV['RAILS_ROOT'] || "/Developer/betterplace"
bluepill_base = ((rails_env == 'development') ? File.join(rails_root, 'tmp', 'bluepill', 'var') : '/var/apps/betterplace/shared/bluepill/var')
log_file = ((rails_env == 'development') ? File.join(rails_root, 'tmp', 'bluepill', 'log') : '/var/apps/betterplace/shared/bluepill/log')

Bluepill.application("unicorn", :log_file => "/#{log_file}/unicorn.log", :base_dir => File.join(bluepill_base)) do |app|
  app.process("unicorn") do |process|
    process.pid_file = File.join(bluepill_base, 'pids', 'unicorn', 'unicorn.pid')
    process.working_dir = rails_root

    process.start_command = "env BUNDLE_GEMFILE=#{rails_root}/Gemfile bundle exec unicorn -Dc #{rails_root}/config/unicorn.rb -E #{rails_env}"
    process.stop_command = "kill -QUIT {{PID}}"
    process.restart_command = "kill -USR2 {{PID}}"

    process.start_grace_time = 120.seconds
    process.stop_grace_time = 30.seconds
    process.restart_grace_time = 120.seconds

    process.monitor_children do |child_process|
      child_process.stop_command = "kill -QUIT {{PID}}"

      child_process.checks :mem_usage, :every => 10.seconds, :below => 280.megabytes, :times => [10,15], :fires => :stop
      child_process.checks :cpu_usage, :every => 10.seconds, :below => 40, :times => [5,8], :fires => :stop
    end

  end
end